<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Challenge</title>

    <!-- Khai báo external các kiểu -->
    <link rel="stylesheet" href="StyleControl.css" type="text/css" />
    

    <script src="js/sweetalert.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="js/DataFactory.js"></script>


    <script>
        var ChallengeList = []
        var UserList = GetStoredData("UserList")
        var CurrentUser = GetStoredData("currentUser")
        var app = angular.module("angularApp", [])
        app.controller("Controller", function ($scope, $http, $sce) {
            $http({
                method: "GET",
                url: "Data/challenge.json"
            }).then(function mySucces(respone) {
                $scope.trustAsHtml = $sce.trustAsHtml //Nhận tag html khi ng-repeat
                //$scope.challenge = respone.data
                ChallengeList = respone.data
                ThisChallenge = []

                for (i = 0; i < Object.keys(ChallengeList).length; i++) {
                    ChallengeList[i]["numday"] = CountDay(ChallengeList[i].createdate)
                    ChallengeList[i]["tagcolor"] = GetTagColor(ChallengeList[i].idtag)
                    ChallengeList[i]["tagname"] = GetTagName(ChallengeList[i].idtag)
                    ChallengeList[i]["numdone"] = ChallengeList[i].todaycomplete.length
                    ChallengeList[i]["todaydone"] = ListUserImg(ChallengeList[i].todaycomplete, UserList)
                    ChallengeList[i]["joinerIMG"] = ListUserImg(ChallengeList[i].joiner, UserList)
                }

                for (qq = 0; qq < LengthOfObj(ChallengeList); qq++) {
                    if (ChallengeList[qq].joiner.includes(CurrentUser.iduser)) {
                        ThisChallenge.push(ChallengeList[qq])
                    }
                }
                $scope.challenge = ThisChallenge

                $scope.ChangeToComplete = function (idcl) {
                    if (document.getElementById(idcl).getAttribute("src") == "IMG/system/checkdone1.png") {
                        SetAttribute(idcl, "src", "IMG/system/checkdone2.png")
                    }
                    else {
                        SetAttribute(idcl, "src", "IMG/system/checkdone1.png")
                    }
                }
                $scope.OpenChallengeDetail = function (idchall) {
                    for (j = 0; j < Object.keys(ChallengeList).length; j++) {
                        console.log(ChallengeList[j])
                        if (ChallengeList[j].idchallenge == idchall) {
                            SaveToLocal("TargetChallenge", ChallengeList[j])
                        }
                    }
                    window.open("ChallengeDetail.html", "_self")
                }


            },
                $http({
                    method: "GET",
                    url: "Data/notify.json"
                }).then(function mySucces(respone) {
                    $scope.notify = respone.data
                    $scope.hideNotify = function (notifyid) {
                        document.getElementById(notifyid).style.display = "none";
                    }
                }, $http({
                    method: "GET",
                    url: "Data/medals.json"
                }).then(function mySucces(respone) {
                    $scope.medals = respone.data
                    SaveToLocal("ListMedals", respone.data.medalinfo)


                }, function myError(respone) {
                    $scope.dataError = respone.statusText
                }))
            )
        });

    </script>

</head>
<body ng-app="angularApp" ng-controller="Controller">
    <a id="tabChallenge" name="tabChallenge" href="Challenge.html">Thử thách</a>
    <a id="tabCommunity" name="tabCommunity" href="Community.html">Cộng đồng</a>
    <input id="txtSearch" name="txtSearch" type="text" placeholder="Tìm kiếm..." />
    <img id="picAva" name="picAva" src="" height="50" width="50" />
    <b id="tabProfile" name="tabProfile" onclick="Go2Profile()" style="color: dodgerblue"></b>


    <div class="row">
        <!--Select menu tab-->
        <div class="column right">
            <h2 style="font-family: Arial; color: grey; margin: 1px;">Thử thách của bạn</h2>
            <p>
                <input type="button" value="Tạo thử thách" onclick="window.open('CreateChallenge.html','_self')"/>
            </p>
            <a href="http://communityuni.com/" target="_blank">
                <img src="IMG/system/adthanh.gif" width="100%" />
            </a>
        </div>

        <!-- Content of Page -->
        <div class="column middle">
            <!--Nội dung newsfeed-->
            <div class="challenge-div" ng-repeat="cl in challenge" id="{{cl.idchallenge}}">
                <div class="challenge-pic">
                    <img src="{{cl.wallpaper}}" style="width: 100%; height: 100px; border-radius: 15px 15px 0px 0px;" />
                    <div class="challenge-name" ng-click="OpenChallengeDetail(cl.idchallenge)">{{cl.name}}</div>
                </div>
                <table width="100%">
                    <tr>
                        <td width="70%">
                            <span style="margin-left: 18px">
                                <span class="tagspan" style="background-color: {{cl.tagcolor}}">{{cl.tagname}} 
                                </span>
                                <span>
                                    <img src="IMG/icon/viewer.png" height="17" width="17" />
                                    {{cl.views}}
                                </span>
                                <br />
                                <span>Ngày thứ {{cl.numday}}
                                </span>
                            </span>
                        </td>
                        <td width="30%" align="right">
                            <span style="color: green; font-size: 12px">Đã có {{cl.numdone}} người  hoàn thành</span><br />
                            <span ng-bind-html="trustAsHtml(cl.todaydone)"></span>
                            <br />
                            <img id="{{cl.name}}" src="IMG/system/checkdone1.png" height="30" width="60" ng-click="ChangeToComplete(cl.name)" />
                        </td>
                    </tr>
                </table>

            </div>
        </div>

        <!-- Show notifications -->
        <div class="column left">
            <div style="background-color: #e6e5e5; padding: 5px;">
                Thông báo
                <div ng-repeat="n in notify" class="notifybox" id="{{n.notifyid}}">
                    <table ng-click="hideNotify(n.notifyid)">
                        <tr>
                            <td rowspan="2">
                                <img src="{{n.icon}}" width="40" height="40" /></td>
                            <td><span style="font-size: 12px; color: dimgray" ng-bind-html="trustAsHtml(n.content)"></span></td>
                            <td rowspan="2">
                                <img src="{{n.image}}" width="40" height="40" class="imagenotify" /></td>
                        </tr>
                        <tr>
                            <td><span style="font-size: 10px; color: dimgray">{{n.time}}</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        var CurrentUser = GetStoredData("currentUser")

        PrintToTag("tabProfile", CurrentUser.name)
        SetAttribute("picAva", "src", CurrentUser.avatar)

        function Go2Profile() {
            GoToProfile(GetStoredData("currentUser").iduser, GetStoredData("UserList"))
        }

        function OpenChallengeList() {
            window.open("ChallengeList.html", "_self")
        }
    </script>
</body>
</html>
